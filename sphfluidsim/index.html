<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>

    <link href='http://fonts.googleapis.com/css?family=Open+Sans+Condensed:700' rel='stylesheet' type='text/css'>
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700&subset=latin,greek-ext" 
          rel="stylesheet" type="text/css"">
    <link rel="stylesheet" type="text/css" href="../css/basic.css">

    <style>
    
    img.indent {
                    position: relative;
                    left: 40px;
                 }
                 
    img.indent_large {
                    position: relative;
                    left: 140px;
                 }
                 
    </style>
    
	<title>Smoothed Particle Hydrodynamics Fluid Simulation</title>
	<meta http-equiv="content-type" content="text/html;charset=utf-8" />
</head>

<body>

  <h1 align="center">Smoothed Particle Hydrodynamics Fluid Simulation</h1>
  <div class="center_column">
  
  <p align="center">Ryan L. Guy<br>
                    University of Victoria<br>
                    Victoria, British Columbia, Canada<br>
                    2015
                    </p>
  
  <br><br>
  <h2>1 Abstract</h2>
  
  <p>This paper presents a simple implementation of a liquid fluid simulation 
  using the method of Smoothed Particle Hydrodynamics (SPH). The SPH model is a 
  Lagrangian method that can be used to model fluid flow by treating each particle 
  as a discrete element of fluid. The implementation covers a set of basic equations 
  used to model a fluid, a spatial data structure to accelerate fluid calculations, 
  and a method to handle interaction between fluid and solid obstacles.
  </p><br>
  
  <h2>2 Introduction</h2>
  
  <p>Each SPH fluid particle is treated as a discrete element of fluid. The motion 
  of a fluid particle is influenced by other particles within some finite radius. 
  The influence a particle has on another is dependent on the distance between the 
  particles. How much influence a particle has on another depends on the smoothing kernel, 
  which is a single variable function dependent on radius. Since the SPH method is pure 
  Lagrangian, a particles motion is based on the current acceleration value at a point in time. 
  The acceleration of a particle takes into account the density, pressure, and relative 
  velocities of it's surrounding particles.
  </p>
  
  <p>In order to calculate the density and pressure of a particle, we need to locate 
  it's neighbour particles within some radius. To efficiently find neighbours for each 
  particle, a spatial grid is used to refine the search to only particles that are near 
  to each other.
  </p>
  
  <p>In this implementation, solid objects are modelled in two different ways. 
  The fluid boundaries are treated as planes that a particle cannot intersect. 
  These planes also provide a repulsive force on the particles to keep them away 
  from the boundaries. Moving objects are treated as a set of fluid particles whose 
  motion are controlled by an external source. These obstacle particles do not move 
  based on their acceleration, but do keep track of their density and pressure so other 
  particles can react to them.
  </p><br>
  
  <h2>3 Implementation</h2>
  
  <p>This section gives relevant implementation details for this SPH fluid simulation 
  and will cover governing equations, time step calculation,  dynamic spatial grid 
  data structure, object-fluid interaction, and user interface.
  </p>
  
  <h3>3.1 Governing Equations</h3>
  
  <p>In order to find a particle's acceleration, it's density and pressure must be 
  calculated. The following equation sums the masses of a particle's neighbours 
  weighted by a kernel function.
  </p>
  
  <br><div align="center"><img src="images/image08.gif" alt="density"></div><br><br>
  
  <p>Where p is density, m is mass and W is the Poly6 smoothing kernel:</p>
  
  <br><div align="center"><img src="images/image05.gif" alt="poly6"></div><br>
  
  <p>Where h (chosen as 0.2) is the smoothing radius and r is the distance between 
     particles. This equation has the advantage of not computing a square root for 
     the distance between particles since r is already squared in the equation.</p>
     
  <p>Once a particle's density is found, the pressure can be computed via the ideal 
  gas law:
  </p>

  <br><div align="center"><img src="images/image09.gif" alt="pressure"></div><br>
  
  <p>Where P is pressure, p is the density of the particle, p0 is the reference density 
  of the fluid and K is a pressure constant. For this implementation the reference 
  density and pressure constant were both chosen to be 20. In this equation, 
  density is set to the reference density if the value is less than the reference 
  density to avoid negative pressures.
  </p>
  
  <p>Now that the pressure and density of all particles are calculated, the acceleration 
  of a particle can be computed as:
  </p>
  
  <br><div align="center"><img src="images/image00.gif" alt="acceleration"></div><br>

  <p>Where a is the acceleration, P is the pressure of the respective particle, r 
  is the normalized vector of the position of particle j to particle i and W is the 
  gradient of the following Spiky kernel smoothing function:
  </p>
  
  <br><div align="center"><img src="images/image03.gif" alt="spikey kernel"></div><br>

  <p>The above acceleration is caused by the mass, density and pressure of the particles. 
  To dampen the motion of the system, the velocities of surrounding particles can be taken 
  into account to add a viscosity term to the acceleration:
  </p>
  
  <br><div align="center"><img src="images/image10.gif" alt="viscosity"></div><br>

  <p>Where av is the acceleration due to viscosity, epsilon is the viscosity constant 
  (chosen as 0.018 in this implementation), v is the velocities of the respective 
  particle, and W is the laplacian of the following viscosity smoothing kernel:
  </p>
  
  <br><div align="center"><img src="images/image04.gif" alt="viscosity kernel"></div><br>
  
  <p>In addition to adding the viscosity term to the particle's acceleration, the 
  acceleration due to the force of gravity is also added.
  </p>
  
  <h3>3.2 Calculating Time Step</h3>
  
  <p>The goal of choosing a time step is to choose the largest value such that a 
  particle will move less than one smoothing radius. The following equation was 
  used in this implementation:
  </p>
  
  <br><div align="center"><img src="images/image12.gif" alt="time step"></div><br>
  
  <p>Where v and a are the maximum velocities and accelerations in the particle system, 
  c is the speed of sound, and C is the Courant safety constant, chosen as 1.0 in this 
  simulation. The safety constant can be set to a higher value for larger timesteps. 
  The speed of sound is calculated with the following equation:
  </p>
  
  <br><div align="center"><img src="images/image07.gif" alt="speed of sound"></div><br>
  
  <p>Where c is the speed of sound and gamma is the ratio of specific heats, which 
  is set to 1.0 in this simulation.</p>
  
  <h3>3.3 Dynamic Spatial Grid</h3>
  
  <p>In order to accelerate the nearest neighbour search of all particles, a fixed 
  width spatial grid data structure was implemented. The size of the grid is dynamic, 
  and grid cells only exist where there is fluid. This means that the memory usage of 
  the grid is proportional to the amount of fluid.
  </p>
  
  <p>Grid cells are contained in a chained hash table according to the following 
  hash function:
  </p>

  <br><div align="center"><img src="images/image02.gif" alt="worly hash"></div><br>
  
  <p>Where i, j, k are the respective x, y, z grid indices. The grid cell width is 
  set to one smoothing radius. </p>
  
  <p>Since the particles are only looking up the nearest neighbours within one smoothing 
  radius, we know that at most the particle's cell and 26 cell neighbours need to be 
  looked up. To speed up this process, and to avoid repetitive hash lookups, each grid 
  cell keeps track of it's direct neighbours in an array.
  </p>

  <br><div align="center"><img src="images/image06.png" 
                               alt="Dynamic Spatial Grid"></div><br>
  <p align="center"><i>Figure 1. Dynamic Spatial Grid</i></p>

  <h3>3.4 Object-Fluid Interaction</h3>
  
  <p>Object-fluid interaction is handled in two separate ways depending on the type 
  of object. Static Fluid boundaries are handled with planes that the particles cannot 
  intersect. The boundary planes are given an increasing repulsive force to push away 
  particles that are too close to the boundary. If a particle hits a boundary, the 
  particle's velocity is adjusted so that it bounces off the surface.
  </p>
  
  <p>Moving objects are handled by constructing the shape with fluid particles. These 
  obstacle particles interact with regular fluid particles as if they were a fluid, 
  except that their motion is controlled by an external force instead of acceleration. 
  Since obstacle particles are not affected by acceleration, only their pressure and 
  density values are computed. Each obstacle particle is updated for velocity depending 
  on the motion of the object.</p>
  
  <br><div align="center"><img src="images/image01.jpg" alt="object interaction"></div><br>
  <p align="center"><i>Figure 2. Object-Fluid Interaction</i></p>
  
  <h3>3.5 User Interface</h3>
  
  <p>The simulation of a SPH fluid requires the fine-tuning of many constants. 
  Instead of providing a graphical user interface, the simulation  is controlled 
  by a Lua script file. This allows the user to change constants and control 
  simulation settings and rendering options while the program is running.
  </p><br>
  
  <h2>4 Results</h2>
  
  <p>To gauge the speed of the simulation, a dam break scenario was created and 
  tested on three datasets of 48958, 98958, and 210504 particles respectively. 
  The dam break consists of three object panels holding back a column of fluid. The 
  middle panel is then lifted to release the fluid.
  </p>
  
  <br><div align="center"><img src="images/image11.jpg" alt="Dam Break"></div><br>
  <p align="center"><i>Figure 3. Dam Break Scenario</i></p>
  
  <p>During testing, five timing metrics were logged for each frame of simulation: 
  total time, nearest neighbour search time, simulation update time, graphics update 
  time, and graphics draw time.</p>
  
  <p>The following table displays the total time results for each test in average 
  minutes per simulation seconds (how long it takes to simulate one second). Each 
  test was ran for 1000 frames at 120 frames per second.
  </p>
  
  <br><div align="center"><img src="images/simtimes.png" alt="Timing Results"></div><br>
  <p align="center"><i>Table 1. Simulation Times</i></p>
  
  <p>The following table displays the proportion of time spent running the major 
  processes of the simulation.</p>
  
  <br><div align="center"><img src="images/simproportions.png" alt="Timing Results"></div><br>
  <p align="center"><i>Table 2. Proportion of Simulation Times</i></p>
  
  <p>We can see that the major bottleneck in this simulation is the nearest 
  neighbour search.
  </p><br>
  
  <h2>5 Conclusions</h2>
  
  <p>Overall, this SPH fluid simulation method was a simple to implement and gives 
  graphically believable results for a compressible fluid. Simulation constants 
  are difficult to tweak in order to achieve an incompressible fluid such as water. 
  To model an incompressible fluid, a grid based Navier-Stokes solver would produce more
  realistic results. 
  </p>
  
  <p>The major bottleneck in simulating a SPH fluid is the nearest neighbour search. 
  To speed up simulation times, effort should be focused on optimizing the spatial 
  grid.</p><br>
  
  <h2>6 References</h2>
  
  <p>
  Roy, Trina. "Physically-Based Fluid Modeling Using Smoothed Particle Hydrodynamics." 
  <i>Physically-Based<br> Fluid Modeling Using Smoothed Particle Hydrodynamics.</i> 1 Jan. 
  1995. Web. 5 Jan. 2015. <br>&#60;http://www.plunk.org/~trina/thesis/html/thesis_toc.html&#62;.
  </p>
  
  <p>Cline, David, David Cardon, and Parris K. Egbert. <i>Fluid Flow for the Rest 
  of Us: Tutorial of the Marker and <br>Cell Method in Computer Graphics.</i>
  N.p.: n.p., n.d. PDF.</p>
  
  <p>Braun, Lucas, and Thomas Lewiner. <i>An Initiation to SPH.</i> Rio De Janeiro, 
  Brazil: Department of Mathematics, <br>PUC-Rio, n.d. PDF.</p>
  
  <p>Wang, Lei. "Fluid with Free Surfaces by Smoothed Particle Hydrodynamics." 
  <i>Lei Wang.</i> Web. 5 Jan. 2015. 
  <br><http://web.cse.ohio-state.edu/~wangle/courses/788au11/788au11.html>.</p>
  
  <p>T, Jakobsen. <i>SPH Survival Kit.</i> N.p.: n.p., n.d. PDF.</p><br><br>
  
  <h2>Video</h2>
  
  <p>The following video is of test footage captured during the building of the
  program.</p>
  
  <iframe width="800" height="450" 
    src="http://www.youtube.com/embed/iHACAlfYeiQ" frameborder="0" allowfullscreen>
  </iframe><br><br>
  
  <h2>Downloads</h2>
  
  <p><b>Download for QT 5.3.0:</b> 
  <a href="downloads/sphfluidsim.zip" target="_blank">SPH Fluid Simulation</a></p>
  
  <p><b>Download Presentation Slides:</b> 
  <a href="downloads/sphfluidsim_presentationslides.pdf" target="_blank">
  Presentation Slides</a></p>
  
  <b>Source: </b><a href="https://github.com/rlguy/sphfluidsim">
                    https://github.com/rlguy/sphfluidsim</a>
  
  </div>
  
  <div class="blank">
  </div>
  
</body>
</html>















